import random

def render_map(width, height, player_x, player_y, discovered, victory_tile, levers, cats, show_all=True):
    print(" _" * 40)

    for y in range(height, 0, -1):
        row = []
        for x in range(1, width + 1):
            pos = (x, y)

            if (x,y) == (player_x, player_y):
                row.append("P")

            elif (pos in discovered) or show_all:
                if pos == victory_tile:
                    row.append("V")
                elif pos in levers and levers[pos] > 0:
                    row.append("L")
                elif pos in cats and cats[pos] > 0:
                    row.append("C")
                else:
                    row.append(".")
            else:
                row.append("?")

        print("".join(row))
    print("\nP=Player, V=Victory Tile, L=Lever, C=Cat, .=Discovered, ?=Undiscovered")
    print(" _" * 40)
    print()



def get_valid_directions(x, y, width, height):
    directions = []

    if y < height:
        directions.append('n')
    if y > 1:
        directions.append('s')
    if x < width:
        directions.append('e')
    if x > 1:
        directions.append('w')

    return directions


def direction_string(directions):
    dir_map = {
        'n': '(N)orth',
        'e': '(E)ast',
        's': '(S)outh',
        'w': '(W)est'
    }
    return f"You can travel: {' or '.join(dir_map[d] for d in directions)}."


def move(x, y, direction):
    if direction == 'n':
        return x, y + 1
    if direction == 's':
        return x, y - 1
    if direction == 'e':
        return x + 1, y
    if direction == 'w':
        return x - 1, y
    return x, y


def init_levers(width, height, count=4, forbidden=None):
    if forbidden is None:
        forbidden = []

    levers = {}
    while len(levers) < count:
        x = random.randint(1, width)
        y = random.randint(1, height)
        if (x, y) not in forbidden:
            levers[(x, y)] = random.randint(1, 3)
    return levers


def handle_lever(x, y, levers, gold):
    if (x, y) in levers:
        if levers[(x, y)] > 0:
            choice = input("You see a lever. Pull it? (y/n): ").lower()
            if choice == 'y':
                levers[(x, y)] -= 1
                gold += 1
                print("You receive a gold coin.")
        else:
            print("The lever here is depleted.")
    return gold

def init_cat(width, height, count=1, forbidden=None):
    if forbidden is None:
        forbidden = []

    cats = {}
    while len(cats) < count:
        x = random.randint(1, width)
        y = random.randint(1, height)
        if (x, y) not in forbidden:
            cats[(x, y)] = random.randint(1, 3)
    return cats


def handle_cat(x, y, cats):
    if (x, y) in cats:
        if cats[(x, y)] > 0:
            choice = input("You see a cat would you like to (p)et it or (k)ill it: ").lower()
            if choice == 'p':
                print("The cat likes you, for you are a good person")
            elif choice == "k":
                print("You monster how could you kill the cat")
            else:
                print("The cat is confused by your actions and walks away")
    return cats



def main():
    width = random.randint(3, 9)
    height = random.randint(3, 9)

    x, y = 1, 1
    gold = 0
    discovered = {(1,1)}

    victory_tile = (random.randint(1, width), random.randint(1, height))
    while victory_tile == (1, 1):
        victory_tile = (random.randint(1, width), random.randint(1, height))

    levers = init_levers(
        width,
        height,
        count=4,
        forbidden=[(1, 1), victory_tile]
    )

    cats = init_cat(
        width,
        height,
        count=1,
        forbidden=[(1, 1), victory_tile]
    )

    print(f"Map size: {width} x {height}")
    print("Find the victory tile!\n")

    while True:
        discovered.add((x, y))
        render_map(width, height, x, y, discovered, victory_tile, levers, cats)

        print(f"Gold: {gold}")
        print(f"You are on tile ({x}, {y}).")

        if (x, y) == victory_tile:
            print("Victory! You found the goal!")
            break

        gold = handle_lever(x, y, levers, gold)

        cats = handle_cat(x,y,cats)

        valid_directions = get_valid_directions(x, y, width, height)
        print(direction_string(valid_directions))

        direction = input("Direction: ").lower().strip()
        direction = direction[:1]
        if direction in valid_directions:
            x, y = move(x, y, direction)
        else:
            print("Not a valid direction!")


main()

